name: Create Release for Pi Deployment

on:
  push:
    tags:
      - 'v*.*.*' # 僅在推送 'v' 開頭的標籤時觸發

jobs:
  # === 工作 1: 建置前端 ===
  build-frontend:
    runs-on: ubuntu-latest
    
    # (修正) 移除了 'if:' 條件，推送標籤時總是執行

    steps:
      - name: 檢查程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: 安裝依賴 (Frontend)
        run: |
          cd ./frontend/e-power-generator-frontend/
          npm install
          
      - name: 建置 (Frontend)
        run: |
          cd ./frontend/e-power-generator-frontend/
          npm run build
      
      - name: (除錯步驟) 顯示建置產物
        run: |
          echo "顯示 ./frontend/e-power-generator-frontend/build 的內容："
          ls -lR ./frontend/e-power-generator-frontend/build
          
      - name: 上傳建置產物
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ./frontend/e-power-generator-frontend/build # 確保此路徑與上方 'ls' 顯示的一致

  # === 工作 2: 建置後端 (修正為跨平台編譯) ===
  build-backend:
    runs-on: ubuntu-latest
    
    # (修正) 移除了 'if:' 條件

    steps:
      - name: 檢查程式碼
        uses: actions/checkout@v4

      - name: 設定 Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.20 # 您指定的版本

      - name: (修正) 跨平台編譯 for Raspberry Pi (ARM64)
        env:
          GOOS: linux
          GOARCH: arm64 # 假設 Pi 是 64-bit
          CGO_ENABLED: 0
        run: |
          cd ./backend
          go build -v -o ./server-arm64 ./cmd/server
        
      - name: 上傳建置產物
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: ./backend/server-arm64 # 上傳編譯好的 ARM 執行檔

  # === 工作 3: 打包並建立 Release ===
  package-and-release:
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend] # 等待前兩個工作完成
    permissions:
      contents: write # 需要此權限才能建立 Release

    steps:
      - name: 獲取 Git 標籤
        run: echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: 下載前端產物
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./dist/static # 下載到 Go 程式準備提供的 'static' 資料夾

      - name: 下載後端產物
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: ./dist # 下載到 'dist' 根目錄

      - name: 準備打包
        run: |
          mv ./dist/server-arm64 ./dist/server
          echo "打包檔案結構："
          ls -lR ./dist

      - name: Gzip 壓縮 .tar 檔 (改為 .tar.gz)
        run: |
          cd ./dist
          tar -czf ../release-arm64.tar.gz server static
          cd ..

      - name: 建立 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          files: |
            ./release-arm64.tar.gz # 上傳 .tar.gz 檔案
